# dataca
goods = {
    "Silk": {
        "base_value": 100,
        "rarity": 5
    },
    "Spices": {
        "base_value": 150,
        "rarity": 4
    },
    "Tea": {
        "base_value": 80,
        "rarity": 3
    },
    "Porcelain": {
        "base_value": 120,
        "rarity": 4
    },
    "Precious Gems": {
        "base_value": 300,
        "rarity": 6
    },
    "Gold and Silver": {
        "base_value": 250,
        "rarity": 5
    },
    "Textiles": {
        "base_value": 70,
        "rarity": 2
    },
    "Paper": {
        "base_value": 50,
        "rarity": 2
    },
    "Ivory": {
        "base_value": 200,
        "rarity": 5
    },
    "Glassware": {
        "base_value": 110,
        "rarity": 3
    },
    "Perfumes and Incense": {
        "base_value": 130,
        "rarity": 4
    },
    "Horses": {
        "base_value": 220,
        "rarity": 5
    },
    "Exotic Animals": {
        "base_value": 400,
        "rarity": 6
    },
    "Carpets and Rugs": {
        "base_value": 160,
        "rarity": 3
    },
    "Dyes": {
        "base_value": 90,
        "rarity": 3
    },
}

markets = {
    "Chang'an (Xi'an)": {
        "Silk": 1.5,
        "Spices": 0.8,
        "Tea": 1.2,
        "Porcelain": 1.1,
        "Precious Gems": 0.9,
        "Gold and Silver": 1.0,
        "Textiles": 1.3,
        "Paper": 1.4,
        "Ivory": 0.7,
        "Glassware": 1.2,
        "Perfumes and Incense": 0.9,
        "Horses": 1.0,
        "Exotic Animals": 0.5,
        "Carpets and Rugs": 0.8,
        "Dyes": 1.1
    },
    "Samarkand": {
        "Silk": 1.2,
        "Spices": 1.3,
        "Tea": 1.0,
        "Porcelain": 1.0,
        "Precious Gems": 1.5,
        "Gold and Silver": 1.1,
        "Textiles": 0.9,
        "Paper": 0.8,
        "Ivory": 1.2,
        "Glassware": 0.9,
        "Perfumes and Incense": 1.3,
        "Horses": 1.4,
        "Exotic Animals": 0.7,
        "Carpets and Rugs": 1.1,
        "Dyes": 1.2
    },
    "Bukhara": {
        "Silk": 1.3,
        "Spices": 1.1,
        "Tea": 0.9,
        "Porcelain": 1.2,
        "Precious Gems": 1.4,
        "Gold and Silver": 1.0,
        "Textiles": 1.0,
        "Paper": 0.7,
        "Ivory": 1.1,
        "Glassware": 1.0,
        "Perfumes and Incense": 1.2,
        "Horses": 1.3,
        "Exotic Animals": 0.6,
        "Carpets and Rugs": 1.0,
        "Dyes": 1.3
    },
    "Kashgar": {
        "Silk": 1.4,
        "Spices": 1.2,
        "Tea": 1.1,
        "Porcelain": 1.3,
        "Precious Gems": 1.6,
        "Gold and Silver": 1.2,
        "Textiles": 1.1,
        "Paper": 0.9,
        "Ivory": 1.3,
        "Glassware": 1.1,
        "Perfumes and Incense": 1.4,
        "Horses": 1.5,
        "Exotic Animals": 0.8,
        "Carpets and Rugs": 1.3,
        "Dyes": 1.5
    },
    "Constantinople (Istanbul)": {
        "Silk": 1.6,
        "Spices": 1.5,
        "Tea": 1.3,
        "Porcelain": 1.4,
        "Precious Gems": 1.7,
        "Gold and Silver": 1.3,
        "Textiles": 1.4,
        "Paper": 1.2,
        "Ivory": 1.5,
        "Glassware": 1.3,
        "Perfumes and Incense": 1.5,
        "Horses": 1.6,
        "Exotic Animals": 1.0,
        "Carpets and Rugs": 1.5,
        "Dyes": 1.6
    },
    "Baghdad": {
        "Silk": 1.5,
        "Spices": 1.4,
        "Tea": 1.2,
        "Porcelain": 1.3,
        "Precious Gems": 1.6,
        "Gold and Silver": 1.2,
        "Textiles": 1.3,
        "Paper": 1.1,
        "Ivory": 1.4,
        "Glassware": 1.2,
        "Perfumes and Incense": 1.4,
        "Horses": 1.5,
        "Exotic Animals": 0.9,
        "Carpets and Rugs": 1.4,
        "Dyes": 1.5
    },
    "Aleppo": {
        "Silk": 1.4,
        "Spices": 1.3,
        "Tea": 1.1,
        "Porcelain": 1.2,
        "Precious Gems": 1.5,
        "Gold and Silver": 1.1,
        "Textiles": 1.2,
        "Paper": 1.0,
        "Ivory": 1.3,
        "Glassware": 1.1,
        "Perfumes and Incense": 1.3,
        "Horses": 1.4,
        "Exotic Animals": 0.8,
        "Carpets and Rugs": 1.3,
        "Dyes": 1.4
    },
    "Damascus": {
        "Silk": 1.3,
        "Spices": 1.2,
        "Tea": 1.0,
        "Porcelain": 1.1,
        "Precious Gems": 1.4,
        "Gold and Silver": 1.0,
        "Textiles": 1.1,
        "Paper": 0.9,
        "Ivory": 1.2,
        "Glassware": 1.0,
        "Perfumes and Incense": 1.2,
        "Horses": 1.3,
        "Exotic Animals": 0.7,
        "Carpets and Rugs": 1.2,
        "Dyes": 1.3
    },
    "Tehran": {
        "Silk": 1.2,
        "Spices": 1.1,
        "Tea": 0.9,
        "Porcelain": 1.0,
        "Precious Gems": 1.3,
        "Gold and Silver": 0.9,
        "Textiles": 1.0,
        "Paper": 0.8,
        "Ivory": 1.1,
        "Glassware": 0.9,
        "Perfumes and Incense": 1.1,
        "Horses": 1.2,
        "Exotic Animals": 0.6,
        "Carpets and Rugs": 1.1,
        "Dyes": 1.2
    },
    "Merv": {
        "Silk": 1.1,
        "Spices": 1.0,
        "Tea": 0.8,
        "Porcelain": 0.9,
        "Precious Gems": 1.2,
        "Gold and Silver": 0.8,
        "Textiles": 0.9,
        "Paper": 0.7,
        "Ivory": 1.0,
        "Glassware": 0.8,
        "Perfumes and Incense": 1.0,
        "Horses": 1.1,
        "Exotic Animals": 0.5,
        "Carpets and Rugs": 1.0,
        "Dyes": 1.1
    },
    "Herat": {
        "Silk": 1.0,
        "Spices": 0.9,
        "Tea": 0.7,
        "Porcelain": 0.8,
        "Precious Gems": 1.1,
        "Gold and Silver": 0.7,
        "Textiles": 0.8,
        "Paper": 0.6,
        "Ivory": 0.9,
        "Glassware": 0.7,
        "Perfumes and Incense": 0.9,
        "Horses": 1.0,
        "Exotic Animals": 0.4,
        "Carpets and Rugs": 0.9,
        "Dyes": 1.0
    },
    "Khotan": {
        "Silk": 1.3,
        "Spices": 1.2,
        "Tea": 1.0,
        "Porcelain": 1.1,
        "Precious Gems": 1.4,
        "Gold and Silver": 1.1,
        "Textiles": 1.2,
        "Paper": 0.8,
        "Ivory": 1.3,
        "Glassware": 1.0,
        "Perfumes and Incense": 1.2,
        "Horses": 1.4,
        "Exotic Animals": 0.7,
        "Carpets and Rugs": 1.2,
        "Dyes": 1.3
    },
    "Antioch": {
        "Silk": 1.4,
        "Spices": 1.3,
        "Tea": 1.1,
        "Porcelain": 1.2,
        "Precious Gems": 1.5,
        "Gold and Silver": 1.2,
        "Textiles": 1.3,
        "Paper": 0.9,
        "Ivory": 1.4,
        "Glassware": 1.1,
        "Perfumes and Incense": 1.3,
        "Horses": 1.5,
        "Exotic Animals": 0.8,
        "Carpets and Rugs": 1.3,
        "Dyes": 1.4
    },
    "Sarai": {
        "Silk": 1.2,
        "Spices": 1.1,
        "Tea": 0.9,
        "Porcelain": 1.0,
        "Precious Gems": 1.3,
        "Gold and Silver": 1.0,
        "Textiles": 1.1,
        "Paper": 0.7,
        "Ivory": 1.2,
        "Glassware": 0.9,
        "Perfumes and Incense": 1.1,
        "Horses": 1.3,
        "Exotic Animals": 0.6,
        "Carpets and Rugs": 1.2,
        "Dyes": 1.3
    },
    "Venice": {
        "Silk": 1.5,
        "Spices": 1.4,
        "Tea": 1.3,
        "Porcelain": 1.4,
        "Precious Gems": 1.6,
        "Gold and Silver": 1.3,
        "Textiles": 1.4,
        "Paper": 1.1,
        "Ivory": 1.5,
        "Glassware": 1.3,
        "Perfumes and Incense": 1.4,
        "Horses": 1.6,
        "Exotic Animals": 0.9,
        "Carpets and Rugs": 1.5,
        "Dyes": 1.6
    },
}

# Importing necessary classes from caravan_management.py
from caravan_management import Caravan, CaravanResources

# Trading System


class Market:

    def __init__(self, name, goods_prices, currency_exchange_rates):
        self.name = name
        self.goods_prices = goods_prices
        self.currency_exchange_rates = currency_exchange_rates

    def display_goods(self):
        print(f"Goods available in {self.name}:")
        for good, multiplier in self.goods_prices.items():
            price = goods[good]['base_value'] * multiplier
            print(f"{good}: {price} per unit")

    def display_exchange_rates(self):
        print(f"Exchange rates in {self.name}:")
        for currency, rate in self.currency_exchange_rates.items():
            print(f"{currency}: {rate} Gold Coins")


class Player:

    def __init__(self, caravan):
        self.caravan = caravan
        self.goods = {key: 0 for key in goods.keys()}
        self.currencies = self.caravan.resources.__dict__  # Linking player currencies to caravan resources

    def display_inventory(self):
        print("Your goods:")
        for good, quantity in self.goods.items():
            print(f"{good}: {quantity} units")
        print("Your currencies:")
        for currency, amount in self.currencies.items():
            print(f"{currency}: {amount} units")

    def trade_goods(self, market, good, quantity, buying=True):
        if buying:
            cost = goods[good]['base_value'] * market.goods_prices[
                good] * quantity
            if self.currencies['money'] >= cost:
                self.currencies['money'] -= cost
                self.goods[good] += quantity
                print(
                    f"Bought {quantity} units of {good} for {cost} Gold Coins."
                )
            else:
                print("Not enough Gold Coins.")
        else:
            if self.goods[good] >= quantity:
                revenue = goods[good]['base_value'] * market.goods_prices[
                    good] * quantity
                self.currencies['money'] += revenue
                self.goods[good] -= quantity
                print(
                    f"Sold {quantity} units of {good} for {revenue} Gold Coins."
                )
            else:
                print("Not enough goods to sell.")

    def exchange_currency(self, market, from_currency, to_currency, amount):
        from_rate = market.currency_exchange_rates[from_currency]
        to_rate = market.currency_exchange_rates[to_currency]
        if self.currencies[from_currency] >= amount:
            exchanged_amount = amount * to_rate / from_rate
            self.currencies[from_currency] -= amount
            self.currencies[to_currency] += exchanged_amount
            print(
                f"Exchanged {amount} {from_currency} for {exchanged_amount:.2f} {to_currency}."
            )
        else:
            print(f"Not enough {from_currency} to exchange.")


def visit_market(player, market_name):
    market = Market(market_name, markets[market_name], {
        'Gold Coins': 1.0,
        'Dinars': 0.8,
        'Drachms': 1.2
    })
    market.display_goods()
    market.display_exchange_rates()
    player.display_inventory()

    while True:
        action = input("What do you want to do? (buy/sell/exchange/leave): "
                       ).strip().lower()
        if action == "buy":
            good = input("Enter the good you want to buy: ").strip()
            quantity = int(input("Enter the quantity you want to buy: "))
            player.trade_goods(market, good, quantity, buying=True)
        elif action == "sell":
            good = input("Enter the good you want to sell: ").strip()
            quantity = int(input("Enter the quantity you want to sell: "))
            player.trade_goods(market, good, quantity, buying=False)
        elif action == "exchange":
            from_currency = input(
                "Enter the currency you want to exchange from: ").strip()
            to_currency = input(
                "Enter the currency you want to exchange to: ").strip()
            amount = float(
                input(
                    f"Enter the amount of {from_currency} you want to exchange: "
                ))
            player.exchange_currency(market, from_currency, to_currency,
                                     amount)
        elif action == "leave":
            break
        else:
            print("Invalid action. Please try again.")
